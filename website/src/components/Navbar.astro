---
import { Select } from 'webcoreui/astro'

const img = (src: string, invert = false) =>
  `<img src="${src}" width="16" height="16" style="object-fit:contain;flex-shrink:0${invert ? ';filter:invert(1)' : ''}" />`

const ideGroups = [
  {
    title: 'Recommended',
    items: [
      { name: 'Claude Code',    value: 'claude-code',    icon: img('/logos/claude.svg') },
      { name: 'Cursor',         value: 'cursor',         icon: img('/logos/cursor.webp', true) },
      { name: 'Windsurf',       value: 'windsurf',       icon: img('/logos/windsurf.webp') },
      { name: 'GitHub Copilot', value: 'github-copilot', icon: img('/logos/github-copilot.webp', true) },
      { name: 'Antigravity',    value: 'antigravity',    icon: img('/logos/antigravity.webp') },
    ],
  },
  {
    title: 'Others',
    items: [
      { name: 'Auggie',    value: 'auggie' },
      { name: 'Cline',     value: 'cline' },
      { name: 'Codex',     value: 'codex' },
      { name: 'Crush',     value: 'crush' },
      { name: 'Gemini CLI',value: 'gemini' },
      { name: 'iFlow',     value: 'iflow' },
      { name: 'KiloCoder', value: 'kilo' },
      { name: 'Kiro',      value: 'kiro' },
      { name: 'OpenCode',  value: 'opencode' },
      { name: 'QwenCoder', value: 'qwen' },
      { name: 'Roo Cline', value: 'roo' },
      { name: 'Rovo Dev',  value: 'rovo-dev' },
      { name: 'Trae',      value: 'trae' },
    ],
  },
]
---

<nav class="fixed top-0 left-0 right-0 z-50 border-b border-white/10 backdrop-blur-md bg-black/80">
  <div class="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">

    <!-- Logo -->
    <a href="/" class="flex items-center gap-2.5 group">
      <div class="w-8 h-8 bg-white rounded-md flex items-center justify-center flex-shrink-0">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 4.5L7.5 9L3 13.5" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M9 13.5H15" stroke="#000" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <span class="hidden md:inline font-bold text-white tracking-tight">PR Review Kit</span>
    </a>

    <!-- Nav links -->
    <div class="hidden md:flex items-center gap-8">
      <a href="#how-it-works" class="text-sm text-white/60 hover:text-white transition-colors">How it works</a>
      <a href="#platforms"    class="text-sm text-white/60 hover:text-white transition-colors">Platforms</a>
      <a href="#quick-start"  class="text-sm text-white/60 hover:text-white transition-colors">Quick Start</a>
      <a href="/docs" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1.5 text-sm text-white/60 hover:text-white transition-colors">
        Documentation
        <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="opacity-40">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
        </svg>
      </a>
    </div>

    <!-- IDE Selector + Hamburger -->
    <div class="flex items-center gap-2.5">
      <span class="hidden md:inline text-xs text-white/35 font-medium tracking-widest uppercase select-none">Your IDE</span>
      <div class="prr-ide-select">
        <Select
          name="ide"
          placeholder="Select your IDE"
          itemGroups={ideGroups}
          showSearchBar={true}
          searchBarPlaceholder="Search your IDE"
          maxHeight="320px"
        />
      </div>
      <!-- Hamburger button (mobile only) -->
      <button id="nav-hamburger" class="md:hidden flex items-center justify-center w-8 h-8 text-white/60 hover:text-white transition-colors" aria-label="Menu">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
    </div>

  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" class="hidden border-t border-white/10 bg-black/95 md:hidden">
    <div class="px-6 py-3 flex flex-col">
      <a href="#how-it-works" class="py-3 text-sm text-white/60 hover:text-white transition-colors border-b border-white/5">How it works</a>
      <a href="#platforms"    class="py-3 text-sm text-white/60 hover:text-white transition-colors border-b border-white/5">Platforms</a>
      <a href="#quick-start"  class="py-3 text-sm text-white/60 hover:text-white transition-colors border-b border-white/5">Quick Start</a>
      <a href="/docs" target="_blank" rel="noopener noreferrer" class="py-3 flex items-center gap-1.5 text-sm text-white/60 hover:text-white transition-colors">
        Documentation
        <svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="opacity-40">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
        </svg>
      </a>
    </div>
  </div>
</nav>

<style>
  .prr-ide-select :global(label) {
    margin: 0;
    gap: 0;
  }
  .prr-ide-select :global(input) {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 0.5rem;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.8125rem;
    height: 2rem;
    width: 13rem;
    padding: 0 1.75rem 0 0.625rem;
    cursor: pointer;
    transition: border-color 0.15s;
    padding-left: 2rem !important;
  }
  .prr-ide-select :global(input::placeholder) {
    color: rgba(255, 255, 255, 0.3);
  }
  .prr-ide-select :global(input:hover) {
    border-color: rgba(255, 255, 255, 0.25);
  }
  .prr-ide-select :global(input:focus) {
    border-color: rgba(255, 255, 255, 0.35);
    outline: none;
    box-shadow: none;
  }
  /* Chevron */
  .prr-ide-select :global(label > svg) {
    color: rgba(255, 255, 255, 0.3);
    right: 0.4rem;
  }
  @media (max-width: 767px) {
    .prr-ide-select :global(input) {
      width: 9rem;
    }
  }
</style>

<script>
  interface IdeLogoInfo { src: string; invert?: boolean }

  const IDE_LOGOS: Record<string, IdeLogoInfo> = {
    'claude-code':    { src: '/logos/claude.svg' },
    'cursor':         { src: '/logos/cursor.webp',         invert: true },
    'windsurf':       { src: '/logos/windsurf.webp' },
    'github-copilot': { src: '/logos/github-copilot.webp', invert: true },
    'antigravity':    { src: '/logos/antigravity.webp' },
  }

  const IDE_NAMES: Record<string, string> = {
    'claude-code': 'Claude Code', 'cursor': 'Cursor', 'windsurf': 'Windsurf',
    'antigravity': 'Antigravity', 'auggie': 'Auggie', 'cline': 'Cline',
    'codex': 'Codex', 'crush': 'Crush', 'gemini': 'Gemini CLI',
    'github-copilot': 'GitHub Copilot', 'iflow': 'iFlow', 'kilo': 'KiloCoder',
    'kiro': 'Kiro', 'opencode': 'OpenCode', 'qwen': 'QwenCoder',
    'roo': 'Roo Cline', 'rovo-dev': 'Rovo Dev', 'trae': 'Trae',
  }

  function updateLogoOverlay(value: string) {
    const input = document.querySelector('[data-id="w-select-ide"]') as HTMLInputElement | null
    const ide = IDE_LOGOS[value]

    // Remove existing logo overlay if present
    const existing = document.getElementById('ide-selected-logo')
    if (existing) existing.remove()

    if (ide && input) {
      const label = input.closest('label') as HTMLElement | null
      if (!label) return
      label.style.position = 'relative'
      const img = document.createElement('img')
      img.id = 'ide-selected-logo'
      img.src = ide.src
      img.width = 16
      img.height = 16
      img.style.cssText = `
        position:absolute;left:0.625rem;top:50%;transform:translateY(-50%);
        object-fit:contain;pointer-events:none;z-index:10;flex-shrink:0;
        ${ide.invert ? 'filter:invert(1)' : ''}
      `
      label.appendChild(img)
      input.style.paddingLeft = '2rem'
    } else if (input) {
      input.style.paddingLeft = ''
    }
  }

  function init() {
    const stored = localStorage.getItem('prr-ide') || 'claude-code'

    if (stored) {
      const input = document.querySelector('[data-id="w-select-ide"]') as HTMLInputElement | null
      if (input && IDE_NAMES[stored]) input.value = IDE_NAMES[stored]
      updateLogoOverlay(stored)
    }

    window.dispatchEvent(new CustomEvent('prr-ide-changed', { detail: stored }))
  }

  document.addEventListener('selectOnChange', (e: Event) => {
    const detail = (e as CustomEvent).detail
    if (detail?.select !== 'ide') return
    localStorage.setItem('prr-ide', detail.value)
    updateLogoOverlay(detail.value)
    window.dispatchEvent(new CustomEvent('prr-ide-changed', { detail: detail.value }))
  })

  document.addEventListener('astro:after-swap', init)
  init()

  // Hamburger toggle
  function initHamburger() {
    const hamburger = document.getElementById('nav-hamburger')
    const mobileMenu = document.getElementById('mobile-menu')
    if (!hamburger || !mobileMenu) return

    hamburger.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden')
    })

    mobileMenu.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu.classList.add('hidden')
      })
    })
  }

  document.addEventListener('astro:after-swap', initHamburger)
  initHamburger()
</script>
